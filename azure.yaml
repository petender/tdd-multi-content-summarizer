# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: tdd-multi-content-summarizer
metadata:
  template: tdd-multi-content-summarizer@v1.0.0

services:
  api:
    project: ./api
    language: py
    host: function
  
  web:
    project: ./web
    language: js
    host: appservice
    dist: out
    hooks:
      prepackage:
        windows:
          shell: pwsh
          run: |
            Write-Host "=== Installing dependencies ==="
            if (-not (Test-Path "node_modules")) {
              npm ci
            } else {
              Write-Host "node_modules already exists, skipping npm ci"
            }
            
            Write-Host "=== Building Next.js app ==="
            npm run build
            
            Write-Host "=== Copying startup.js to out/ ==="
            Copy-Item -Path "startup.js" -Destination "out/startup.js" -Force
            Write-Host "Copied startup.js"
            
            Write-Host "=== Creating config.js ==="
            # Check if FUNCTIONS_URI exists (from bicep outputs after provision)
            try {
              $functionsUri = azd env get-value FUNCTIONS_URI 2>$null
              if ($functionsUri -and $functionsUri -notlike "*ERROR*") {
                $apiUrl = "$functionsUri/api"
                Write-Host "Using Function URL from environment: $apiUrl"
                "window.__API_URL__ = '$apiUrl';" | Set-Content -Path "public/config.js" -Encoding UTF8 -NoNewline
              } else {
                Write-Host "FUNCTIONS_URI not found, using placeholder"
                "window.__API_URL__ = '/api';" | Set-Content -Path "public/config.js" -Encoding UTF8 -NoNewline
              }
            } catch {
              Write-Host "FUNCTIONS_URI not available yet, using placeholder"
              "window.__API_URL__ = '/api';" | Set-Content -Path "public/config.js" -Encoding UTF8 -NoNewline
            }
            Write-Host "Created public/config.js"
            
            Write-Host "=== Creating package.json for serve ==="
            @'
            {
              "name": "video-summarizer-static",
              "version": "1.0.0",
              "private": true,
              "dependencies": {
                "serve": "^14.2.1"
              },
              "scripts": {
                "start": "serve . -s -p 8080"
              }
            }
            '@ | Set-Content -Path "out/package.json" -Encoding UTF8
            Write-Host "Created out/package.json"
            
            exit 0
        posix:
          shell: sh
          run: |
            echo "=== Installing dependencies ==="
            if [ ! -d "node_modules" ]; then
              npm ci
            else
              echo "node_modules already exists, skipping npm ci"
            fi
            
            echo "=== Building Next.js app ==="
            npm run build
            
            echo "=== Copying startup.js to out/ ==="
            cp startup.js out/startup.js
            echo "Copied startup.js"
            
            echo "=== Creating config.js ==="
            # Check if FUNCTIONS_URI exists (from bicep outputs after provision)
            functionsUri=$(azd env get-value FUNCTIONS_URI 2>/dev/null || echo "")
            if [ -n "$functionsUri" ] && ! echo "$functionsUri" | grep -q "ERROR"; then
              apiUrl="$functionsUri/api"
              echo "Using Function URL from environment: $apiUrl"
              echo "window.__API_URL__ = '$apiUrl';" > public/config.js
            else
              echo "FUNCTIONS_URI not found, using placeholder"
              echo "window.__API_URL__ = '/api';" > public/config.js
            fi
            echo "Created public/config.js"
            cat public/config.js
            
            echo "=== Creating package.json for serve ==="
            cat > out/package.json << 'EOF'
            {
              "name": "video-summarizer-static",
              "version": "1.0.0",
              "private": true,
              "dependencies": {
                "serve": "^14.2.1"
              },
              "scripts": {
                "start": "serve . -s -p 8080"
              }
            }
            EOF
            echo "Created out/package.json"
            
            exit 0

